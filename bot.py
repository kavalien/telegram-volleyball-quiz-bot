import os
import random
import logging
import psycopg2

from telegram import (
    Update, 
    ReplyKeyboardMarkup, 
    ReplyKeyboardRemove
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    filters,
    ContextTypes,
    PicklePersistence
)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# -------------------------
# –°–æ—Å—Ç–æ—è–Ω–∏—è ConversationHandler
# -------------------------
MAIN_MENU, ASK_NAME, CHOOSE_CATEGORY, ASK_QUESTION = range(4)

# -------------------------
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
# -------------------------
conn = None
cursor = None

def init_db():
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å PostgreSQL (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –±–µ—Ä—ë–º –∏–∑ Railway),
    —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É scoreboard, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç.
    """
    global conn, cursor
    
    # –°—á–∏—Ç—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    dbname = os.environ.get("PGDATABASE")
    user = os.environ.get("PGUSER")
    password = os.environ.get("PGPASSWORD")
    host = os.environ.get("PGHOST")
    port = os.environ.get("PGPORT", "5432")  # –æ–±—ã—á–Ω–æ 5432
    
    if not (dbname and user and password and host):
        logger.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è PostgreSQL (PGDATABASE, PGUSER, PGPASSWORD, PGHOST)!")
        return
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ
    conn = psycopg2.connect(
        dbname=dbname,
        user=user,
        password=password,
        host=host,
        port=port
    )
    cursor = conn.cursor()
    
    # –°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É scoreboard, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS scoreboard (
            user_id TEXT PRIMARY KEY,
            username TEXT,
            score INT
        );
    """)
    conn.commit()
    logger.info("init_db(): –¢–∞–±–ª–∏—Ü–∞ scoreboard –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞.")

def update_score_db(user_id, username, increment):
    """
    –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_id) –Ω–∞ increment.
    –ï—Å–ª–∏ user_id –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É.
    """
    global conn, cursor
    if not cursor:
        logger.error("update_score_db() –≤—ã–∑–≤–∞–Ω –¥–æ init_db()!")
        return
    
    cursor.execute("SELECT score FROM scoreboard WHERE user_id = %s", (user_id,))
    row = cursor.fetchone()
    if row is None:
        # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        cursor.execute(
            "INSERT INTO scoreboard (user_id, username, score) VALUES (%s, %s, %s)",
            (user_id, username, increment)
        )
    else:
        current_score = row[0]
        new_score = current_score + increment
        cursor.execute(
            "UPDATE scoreboard SET username = %s, score = %s WHERE user_id = %s",
            (username, new_score, user_id)
        )
    conn.commit()

def get_top_players_db(limit=10):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-–∏–≥—Ä–æ–∫–æ–≤ (username, score),
    –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ —É–±—ã–≤–∞–Ω–∏—é score, –º–∞–∫—Å–∏–º—É–º limit —à—Ç—É–∫.
    """
    global conn, cursor
    if not cursor:
        logger.error("get_top_players_db() –≤—ã–∑–≤–∞–Ω –¥–æ init_db()!")
        return []
    
    cursor.execute("SELECT username, score FROM scoreboard ORDER BY score DESC LIMIT %s", (limit,))
    rows = cursor.fetchall()  # [(username, score), ...]
    return rows

# -------------------------
# –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ 40 –≤–æ–ø—Ä–æ—Å–æ–≤ (2 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
# -------------------------
quiz_data = {
    "–ü—Ä–∞–≤–∏–ª–∞ –≤–æ–ª–µ–π–±–æ–ª–∞ \U0001F3D0": [
        {
            "question": "1. –ö–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –ø–ª–æ—â–∞–¥–∫–∏ –¥–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": ["9 –º x 9 –º", "18 –º x 9 –º", "16 –º x 8 –º", "20 –º x 10 –º"],
            "answer": "18 –º x 9 –º",
            "explanation": "–ü–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º FIVB –¥–ª–∏–Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –ø–ª–æ—â–∞–¥–∫–∏ 18 –º, —à–∏—Ä–∏–Ω–∞ ‚Äì 9 –º."
        },
        {
            "question": "2. –°–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["4", "5", "6", "7"],
            "answer": "6",
            "explanation": "–í –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ 6 —á–µ–ª–æ–≤–µ–∫ (–ø–ª—é—Å –∑–∞–ø–∞—Å–Ω—ã–µ)."
        },
        {
            "question": "3. –ö–∞–∫–æ–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å —Ä–∞–∑—Ä–µ—à—ë–Ω –¥–ª—è –º—è—á–∞ –≤ –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["250 –≥", "280 –≥", "300 –≥", "320 –≥"],
            "answer": "280 –≥",
            "explanation": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–µ—Å –º—è—á–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 260‚Äì280 –≥."
        },
        {
            "question": "4. –°–∫–æ–ª—å–∫–æ –æ—á–∫–æ–≤ –Ω—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å, —á—Ç–æ–±—ã –≤—ã–∏–≥—Ä–∞—Ç—å —Å–µ—Ç –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["15", "21", "25", "30"],
            "answer": "25",
            "explanation": "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–Ω–∏–º—É–º 25 –æ—á–∫–æ–≤ —Å —Ä–∞–∑–Ω–∏—Ü–µ–π –≤ 2 –æ—á–∫–∞."
        },
        {
            "question": "5. –ö–∞–∫–∞—è –≤—ã—Å–æ—Ç–∞ —Å–µ—Ç–∫–∏ –¥–ª—è –º—É–∂—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": ["2.24 –º", "2.35 –º", "2.43 –º", "2.50 –º"],
            "answer": "2.43 –º",
            "explanation": "–°—Ç–∞–Ω–¥–∞—Ä—Ç FIVB –¥–ª—è –º—É–∂—á–∏–Ω ‚Äî 2,43 –º."
        },
        {
            "question": "6. –°–∫–æ–ª—å–∫–æ —Ç–∞–π–º-–∞—É—Ç–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ –≤ –æ–¥–Ω–æ–º —Å–µ—Ç–µ?",
            "options": ["1", "2", "3", "4"],
            "answer": "2",
            "explanation": "–í –∫–∞–∂–¥–æ–º —Å–µ—Ç–µ (–∫—Ä–æ–º–µ —Ç–∞–π-–±—Ä–µ–π–∫–∞) ‚Äî –¥–≤–∞ —Ç–∞–π–º-–∞—É—Ç–∞ –ø–æ 30 —Å–µ–∫—É–Ω–¥."
        },
        {
            "question": "7. –°–∫–æ–ª—å–∫–æ –∫–∞—Å–∞–Ω–∏–π –º—è—á–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –¥–æ –ø–µ—Ä–µ–¥–∞—á–∏ —á–µ—Ä–µ–∑ —Å–µ—Ç–∫—É?",
            "options": ["2", "3", "4", "5"],
            "answer": "3",
            "explanation": "–ö–æ–º–∞–Ω–¥–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –º–∞–∫—Å–∏–º—É–º —Ç—Ä–∏ –∫–∞—Å–∞–Ω–∏—è (–Ω–µ —Å—á–∏—Ç–∞—è –±–ª–æ–∫)."
        },
        {
            "question": "8. –ö–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –ø–ª–æ—â–∞–¥–∫–∏ –¥–ª—è –ø–ª—è–∂–Ω–æ–≥–æ –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": ["8 –º x 8 –º", "9 –º x 9 –º", "16 –º x 8 –º", "18 –º x 9 –º"],
            "answer": "16 –º x 8 –º",
            "explanation": "–ü–ª—è–∂–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞ 16√ó8 –º, –∫–æ—Ä–æ—á–µ –∏ —É–∂–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π."
        },
        {
            "question": "9. –°–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ –≤ –ø–ª—è–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["2", "3", "4", "6"],
            "answer": "2",
            "explanation": "–ü–ª—è–∂–Ω—ã–π –≤–æ–ª–µ–π–±–æ–ª –∏–≥—Ä–∞—é—Ç 2 –Ω–∞ 2, –±–µ–∑ –∑–∞–º–µ–Ω."
        },
        {
            "question": "10. –í –∫–∞–∫–æ–º —Å–ª—É—á–∞–µ –∫–æ–º–∞–Ω–¥–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –æ—á–∫–æ?",
            "options": [
                "–ú—è—á –∫–∞—Å–∞–µ—Ç—Å—è –ø–æ–ª–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞",
                "–ú—è—á –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –æ—Ç —Å–æ–ø–µ—Ä–Ω–∏–∫–∞",
                "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–º",
                "–í—Å–µ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã–µ"
            ],
            "answer": "–í—Å–µ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã–µ",
            "explanation": "–û—á–∫–æ –∑–∞ –ª—é–±—É—é –æ—à–∏–±–∫—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –∏–ª–∏ –ø–∞–¥–µ–Ω–∏–µ –º—è—á–∞ –Ω–∞ –∏—Ö –ø–ª–æ—â–∞–¥–∫—É."
        },
        {
            "question": "11. –ö–∞–∫–∞—è –≤—ã—Å–æ—Ç–∞ —Å–µ—Ç–∫–∏ –≤ –∂–µ–Ω—Å–∫–æ–º –ø–ª—è–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["2.10 –º", "2.15 –º", "2.24 –º", "2.43 –º"],
            "answer": "2.24 –º",
            "explanation": "–ñ–µ–Ω—Å–∫–∞—è —Å–µ—Ç–∫–∞ –≤ –ø–ª—è–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ ‚Äî 2,24 –º."
        },
        {
            "question": "12. –ö–∞–∫–æ–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á—ë—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–µ—Ç–µ, –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –æ—á–∫–æ–≤ –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –¥–≤—É—Ö?",
            "options": ["25", "30", "35", "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π"],
            "answer": "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π",
            "explanation": "–°–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –ø–æ–∫–∞ –æ–¥–Ω–∞ –∏–∑ –∫–æ–º–∞–Ω–¥ –Ω–µ –¥–æ–±—å—ë—Ç—Å—è +2 –æ—á–∫–∞."
        },
        {
            "question": "13. –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω ¬´–±–ª–æ–∫¬ª?",
            "options": [
                "–£–¥–∞—Ä –ø–æ –º—è—á—É —Å–Ω–∏–∑—É",
                "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –ø—É—Ç–∏ –º—è—á—É –≤–æ–∑–ª–µ —Å–µ—Ç–∫–∏",
                "–ó–∞—â–∏—Ç–Ω—ã–π –ø–∞—Å",
                "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ"
            ],
            "answer": "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –ø—É—Ç–∏ –º—è—á—É –≤–æ–∑–ª–µ —Å–µ—Ç–∫–∏",
            "explanation": "–ë–ª–æ–∫ ‚Äî —ç—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –ø–µ—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—Ç–∞–∫—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞."
        },
        {
            "question": "14. –ö–∞–∫–æ–≤–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π –ø–æ —Å–Ω–µ–∂–Ω–æ–º—É –≤–æ–ª–µ–π–±–æ–ª—É?",
            "options": ["-5 ¬∞C", "-10 ¬∞C", "-15 ¬∞C", "-20 ¬∞C"],
            "answer": "-10 ¬∞C",
            "explanation": "–ß–∞—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –º–∏–Ω–∏–º—É–º -10 ¬∞C –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
        },
        {
            "question": "15. –°–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –≤ —Å–Ω–µ–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["2", "3", "4", "5"],
            "answer": "3",
            "explanation": "–í —Å–Ω–µ–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ –∏–≥—Ä–∞—é—Ç –ø–æ —Ç—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ."
        },
        {
            "question": "16. –°–∫–æ–ª—å–∫–æ —Å–µ—Ç–æ–≤ –∏–≥—Ä–∞—é—Ç –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è?",
            "options": ["3", "4", "5", "6"],
            "answer": "5",
            "explanation": "–ò–≥—Ä–∞ –¥–æ 3 –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ç–æ–≤, –º–∞–∫—Å–∏–º—É–º 5 —Å–µ—Ç–æ–≤."
        },
        {
            "question": "17. –°–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ?",
            "options": ["30 —Å–µ–∫—É–Ω–¥", "60 —Å–µ–∫—É–Ω–¥", "90 —Å–µ–∫—É–Ω–¥", "120 —Å–µ–∫—É–Ω–¥"],
            "answer": "60 —Å–µ–∫—É–Ω–¥",
            "explanation": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã (—Ä–∞–Ω–µ–µ –ø—Ä–∏ —Å—á—ë—Ç–µ 8 –∏ 16) –ø–æ 60 —Å–µ–∫—É–Ω–¥."
        },
        {
            "question": "18. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –º—è—á –∫–∞—Å–∞–µ—Ç—Å—è –ª–∏–Ω–∏–∏ –ø–ª–æ—â–∞–¥–∫–∏?",
            "options": [
                "–ú—è—á —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ –∞—É—Ç–µ",
                "–ú—è—á —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ –∏–≥—Ä–µ",
                "–ò–≥—Ä–æ–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É",
                "–°—É–¥—å—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ"
            ],
            "answer": "–ú—è—á —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ –∏–≥—Ä–µ",
            "explanation": "–ö–∞—Å–∞–Ω–∏–µ –ª–∏–Ω–∏–π —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–ø–∞–¥–∞–Ω–∏–µ–º –≤ –ø–æ–ª–µ."
        },
        {
            "question": "19. –ö–∞–∫–æ–≤–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥–∞—á–∏ –ø–æ—Å–ª–µ —Å–≤–∏—Å—Ç–∫–∞ —Å—É–¥—å–∏?",
            "options": ["5 —Å–µ–∫—É–Ω–¥", "8 —Å–µ–∫—É–Ω–¥", "10 —Å–µ–∫—É–Ω–¥", "12 —Å–µ–∫—É–Ω–¥"],
            "answer": "8 —Å–µ–∫—É–Ω–¥",
            "explanation": "–ü–æ–¥–∞—é—â–∏–π –∏–º–µ–µ—Ç 8 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–¥–∞—á–∏."
        },
        {
            "question": "20. –ú–æ–∂–µ—Ç –ª–∏ –ª–∏–±–µ—Ä–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å –∏–∑ –ø–µ—Ä–µ–¥–Ω–µ–π –∑–æ–Ω—ã?",
            "options": [
                "–ù–µ—Ç, –Ω–∏–∫–æ–≥–¥–∞",
                "–î–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—è—á –Ω–∏–∂–µ —É—Ä–æ–≤–Ω—è —Å–µ—Ç–∫–∏",
                "–î–∞, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π",
                "–ù–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏"
            ],
            "answer": "–î–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—è—á –Ω–∏–∂–µ —É—Ä–æ–≤–Ω—è —Å–µ—Ç–∫–∏",
            "explanation": "–õ–∏–±–µ—Ä–æ –Ω–µ –º–æ–∂–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å –≤—ã—à–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è —Å–µ—Ç–∫–∏."
        },
    ],
    "–ò—Å—Ç–æ—Ä–∏—è –≤–æ–ª–µ–π–±–æ–ª–∞ \U0001F4D6": [
        {
            "question": "21. –ö—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–º –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": ["–î–∂–µ–π–º—Å –ù–µ–π—Å–º–∏—Ç", "–£–∏–ª—å—è–º –î–∂. –ú–æ—Ä–≥–∞–Ω", "–ü—å–µ—Ä –¥–µ –ö—É–±–µ—Ä—Ç–µ–Ω", "–î–∂–æ—Ä–¥–∂ –§–∏—à–µ—Ä"],
            "answer": "–£–∏–ª—å—è–º –î–∂. –ú–æ—Ä–≥–∞–Ω",
            "explanation": "–£–∏–ª—å—è–º –ú–æ—Ä–≥–∞–Ω —Å–æ–∑–¥–∞–ª ¬´–º–∏–Ω—Ç–æ–Ω–µ—Ç¬ª (1895), –≤–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–∏ –≤–æ–ª–µ–π–±–æ–ª."
        },
        {
            "question": "22. –í –∫–∞–∫–æ–º –≥–æ–¥—É –±—ã–ª –∏–∑–æ–±—Ä–µ—Ç—ë–Ω –≤–æ–ª–µ–π–±–æ–ª?",
            "options": ["1891", "1895", "1900", "1912"],
            "answer": "1895",
            "explanation": "–ò–º–µ–Ω–Ω–æ –≤ 1895 –ú–æ—Ä–≥–∞–Ω –ø—Ä–æ–≤—ë–ª –ø–µ—Ä–≤—É—é –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é –Ω–æ–≤–æ–π –∏–≥—Ä—ã."
        },
        {
            "question": "23. –ö–∞–∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –Ω–∞–∑—ã–≤–∞–ª–∞—Å—å –∏–≥—Ä–∞, –ø—Ä–∏–¥—É–º–∞–Ω–Ω–∞—è –ú–æ—Ä–≥–∞–Ω–æ–º?",
            "options": ["–ë–∞–¥–º–∏–Ω—Ç–æ–Ω", "–¢–µ–Ω–Ω–∏–±–æ–ª", "–ú–∏–Ω—Ç–æ–Ω–µ—Ç", "–°—Ñ–µ—Ä–æ–±–æ–ª"],
            "answer": "–ú–∏–Ω—Ç–æ–Ω–µ—Ç",
            "explanation": "–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî ¬´–º–∏–Ω—Ç–æ–Ω–µ—Ç¬ª."
        },
        {
            "question": "24. –ö—Ç–æ –∏–∑–æ–±—Ä—ë–ª –±–∞—Å–∫–µ—Ç–±–æ–ª, —á—Ç–æ –≤–¥–æ—Ö–Ω–æ–≤–∏–ª–æ –ú–æ—Ä–≥–∞–Ω–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": ["–î–∂–µ–π–º—Å –ù–µ–π—Å–º–∏—Ç", "–ê–ª—å—Ñ—Ä–µ–¥ –•–∞–ª—Å—Ç–µ–¥", "–ü—å–µ—Ä –¥–µ –ö—É–±–µ—Ä—Ç–µ–Ω", "–ì–µ–Ω—Ä–∏ –ú–æ—Ä–≥–∞–Ω"],
            "answer": "–î–∂–µ–π–º—Å –ù–µ–π—Å–º–∏—Ç",
            "explanation": "–ù–µ–π—Å–º–∏—Ç —Å–æ–∑–¥–∞–ª –±–∞—Å–∫–µ—Ç–±–æ–ª (1891), –∞ –ú–æ—Ä–≥–∞–Ω –≤–¥–æ—Ö–Ω–æ–≤–∏–ª—Å—è –∏ –ø—Ä–∏–¥—É–º–∞–ª –≤–æ–ª–µ–π–±–æ–ª."
        },
        {
            "question": "25. –í –∫–∞–∫–æ–º –≥–æ–¥—É –≤–æ–ª–µ–π–±–æ–ª –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≤–æ—à—ë–ª –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –û–ª–∏–º–ø–∏–π—Å–∫–∏—Ö –∏–≥—Ä?",
            "options": ["1924", "1948", "1964", "1988"],
            "answer": "1964",
            "explanation": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≤–æ—à—ë–ª –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –¢–æ–∫–∏–æ-1964."
        },
        {
            "question": "26. –í –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–æ—à–ª–∏ –ø–µ—Ä–≤—ã–µ –û–ª–∏–º–ø–∏–π—Å–∫–∏–µ –∏–≥—Ä—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤–æ–ª–µ–π–±–æ–ª?",
            "options": ["–Ø–ø–æ–Ω–∏—è", "–ë—Ä–∞–∑–∏–ª–∏—è", "–°–®–ê", "–ú–µ–∫—Å–∏–∫–∞"],
            "answer": "–Ø–ø–æ–Ω–∏—è",
            "explanation": "–≠—Ç–æ –±—ã–ª–∞ –Ø–ø–æ–Ω–∏—è, –û–ª–∏–º–ø–∏–∞–¥–∞ 1964 –≥–æ–¥–∞ (–¢–æ–∫–∏–æ)."
        },
        {
            "question": "27. –ö–∞–∫–æ–π –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –æ—Ä–≥–∞–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ª–µ–π–±–æ–ª–æ–º –≤–æ –≤—Å—ë–º –º–∏—Ä–µ?",
            "options": ["–§–ò–§–ê (FIFA)", "–§–ò–í–ë (FIVB)", "–ú–û–ö (IOC)", "–§–ò–ë–ê (FIBA)"],
            "answer": "–§–ò–í–ë (FIVB)",
            "explanation": "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è —Ñ–µ–¥–µ—Ä–∞—Ü–∏—è –≤–æ–ª–µ–π–±–æ–ª–∞ (FIVB) —É—á—Ä–µ–∂–¥–µ–Ω–∞ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤."
        },
        {
            "question": "28. –í –∫–∞–∫–æ–º –≥–æ–¥—É –±—ã–ª–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è —Ñ–µ–¥–µ—Ä–∞—Ü–∏—è –≤–æ–ª–µ–π–±–æ–ª–∞ (FIVB)?",
            "options": ["1895", "1908", "1947", "1952"],
            "answer": "1947",
            "explanation": "FIVB —Å–æ–∑–¥–∞–Ω–∞ –≤ 1947, —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã."
        },
        {
            "question": "29. –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —à—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–∞ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏ –≤–æ–ª–µ–π–±–æ–ª–∞ (FIVB)?",
            "options": ["–õ–æ–∑–∞–Ω–Ω–∞ (–®–≤–µ–π—Ü–∞—Ä–∏—è)", "–ü–∞—Ä–∏–∂ (–§—Ä–∞–Ω—Ü–∏—è)", "–ù—å—é-–ô–æ—Ä–∫ (–°–®–ê)", "–ú–æ–Ω—Ä–µ–∞–ª—å (–ö–∞–Ω–∞–¥–∞)"],
            "answer": "–õ–æ–∑–∞–Ω–Ω–∞ (–®–≤–µ–π—Ü–∞—Ä–∏—è)",
            "explanation": "–ú–Ω–æ–≥–∏–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ –õ–æ–∑–∞–Ω–Ω–µ."
        },
        {
            "question": "30. –ö–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ —Å—á–∏—Ç–∞–ª–∞—Å—å –æ–¥–Ω–æ–π –∏–∑ –≤–µ–¥—É—â–∏—Ö –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –≤–æ–ª–µ–π–±–æ–ª–∞ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ XX –≤–µ–∫–∞?",
            "options": ["–ò—Å–ø–∞–Ω–∏—è", "–†–æ—Å—Å–∏—è (–°–°–°–†)", "–ï–≥–∏–ø–µ—Ç", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"],
            "answer": "–†–æ—Å—Å–∏—è (–°–°–°–†)",
            "explanation": "–°–°–°–† –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞–ª –≤–æ–ª–µ–π–±–æ–ª –∏ –¥–æ–±–∏–ª—Å—è –±–æ–ª—å—à–∏—Ö —É—Å–ø–µ—Ö–æ–≤."
        },
        {
            "question": "31. –í –∫–∞–∫–æ–º –≥–æ–¥—É –ø—Ä–æ—à—ë–ª –ø–µ—Ä–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞ –ø–æ –≤–æ–ª–µ–π–±–æ–ª—É —Å—Ä–µ–¥–∏ –º—É–∂—á–∏–Ω?",
            "options": ["1949", "1952", "1956", "1960"],
            "answer": "1949",
            "explanation": "–ü–µ—Ä–≤—ã–π –ß–ú ‚Äî –≤ –ü—Ä–∞–≥–µ (–ß–µ—Ö–æ—Å–ª–æ–≤–∞–∫–∏—è) –≤ 1949 –≥–æ–¥—É."
        },
        {
            "question": "32. –ö–æ–≥–¥–∞ –≤ –°–°–°–† —Å–æ—Å—Ç–æ—è–ª—Å—è –ø–µ—Ä–≤—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç —Å—Ç—Ä–∞–Ω—ã –ø–æ –≤–æ–ª–µ–π–±–æ–ª—É —Å—Ä–µ–¥–∏ –º—É–∂—á–∏–Ω?",
            "options": ["1923", "1933", "1938", "1947"],
            "answer": "1933",
            "explanation": "–í 1933 –≥–æ–¥—É –ø—Ä–æ–≤–µ–ª–∏ –ø–µ—Ä–≤—ã–π –≤—Å–µ—Å–æ—é–∑–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç."
        },
        {
            "question": "33. –ö–∞–∫–æ–≤–æ –±—ã–ª–æ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ –≤ —Å–∞–º–æ–π —Ä–∞–Ω–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –≤–æ–ª–µ–π–±–æ–ª–∞?",
            "options": [
                "–ù–µ –±—ã–ª–æ —á—ë—Ç–∫–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è",
                "–ü–æ 6 —á–µ–ª–æ–≤–µ–∫ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã",
                "–ü–æ 9 —á–µ–ª–æ–≤–µ–∫ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã",
                "–ü–æ 4 —á–µ–ª–æ–≤–µ–∫–∞ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã"
            ],
            "answer": "–ù–µ –±—ã–ª–æ —á—ë—Ç–∫–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è",
            "explanation": "–ú–æ—Ä–≥–∞–Ω –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª —Ç–æ—á–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∏–≥—Ä–æ–∫–æ–≤."
        },
        {
            "question": "34. –í –∫–∞–∫–æ–º –≥–æ–¥—É –≤–ø–µ—Ä–≤—ã–µ –ø—Ä–æ–≤–µ–ª–∏ –ö—É–±–æ–∫ –º–∏—Ä–∞ –ø–æ –≤–æ–ª–µ–π–±–æ–ª—É?",
            "options": ["1959", "1965", "1969", "1977"],
            "answer": "1969",
            "explanation": "–ö—É–±–æ–∫ –º–∏—Ä–∞ FIVB –≤–ø–µ—Ä–≤—ã–µ —Å–æ—Å—Ç–æ—è–ª—Å—è –≤ 1969 –≥–æ–¥—É."
        },
        {
            "question": "35. –ö–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∫–æ—Ä–¥—Å–º–µ–Ω–æ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–±–µ–¥ –Ω–∞ –º—É–∂—Å–∫–∏—Ö —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞—Ö –º–∏—Ä–∞?",
            "options": ["–ë—Ä–∞–∑–∏–ª–∏—è", "–°–°–°–† / –†–æ—Å—Å–∏—è", "–°–®–ê", "–ò—Ç–∞–ª–∏—è"],
            "answer": "–°–°–°–† / –†–æ—Å—Å–∏—è",
            "explanation": "–°–æ–≤–µ—Ç—Å–∫–∞—è/—Ä–æ—Å—Å–∏–π—Å–∫–∞—è —Å–±–æ—Ä–Ω–∞—è —á–∞—â–µ –≤—Å–µ—Ö —Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å —á–µ–º–ø–∏–æ–Ω–æ–º."
        },
        {
            "question": "36. –ö—Ç–æ —Å—Ç–∞–ª –ø–µ—Ä–≤—ã–º –æ–ª–∏–º–ø–∏–π—Å–∫–∏–º —á–µ–º–ø–∏–æ–Ω–æ–º –≤ –º—É–∂—Å–∫–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ –Ω–∞ –ò–≥—Ä–∞—Ö 1964 –≥–æ–¥–∞?",
            "options": ["–Ø–ø–æ–Ω–∏—è", "–ü–æ–ª—å—à–∞", "–°–°–°–†", "–°–®–ê"],
            "answer": "–°–°–°–†",
            "explanation": "–ù–∞ –ø–µ—Ä–≤–æ–º –æ–ª–∏–º–ø–∏–π—Å–∫–æ–º —Ç—É—Ä–Ω–∏—Ä–µ –ø–æ –≤–æ–ª–µ–π–±–æ–ª—É (1964) –∑–æ–ª–æ—Ç–æ —É –°–°–°–†."
        },
        {
            "question": "37. –í –∫–∞–∫–æ–º –≥–æ–¥—É –ø–ª—è–∂–Ω—ã–π –≤–æ–ª–µ–π–±–æ–ª –±—ã–ª –≤–ø–µ—Ä–≤—ã–µ –≤–∫–ª—é—á—ë–Ω –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –û–ª–∏–º–ø–∏–π—Å–∫–∏—Ö –∏–≥—Ä?",
            "options": ["1984", "1992", "1996", "2000"],
            "answer": "1996",
            "explanation": "–ü–ª—è–∂–Ω—ã–π –≤–æ–ª–µ–π–±–æ–ª –¥–µ–±—é—Ç–∏—Ä–æ–≤–∞–ª –≤ –ê—Ç–ª–∞–Ω—Ç–µ (–°–®–ê) –≤ 1996 –≥–æ–¥—É."
        },
        {
            "question": "38. –ì–¥–µ –ø—Ä–æ—à—ë–ª –ø–µ—Ä–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞ –ø–æ –ø–ª—è–∂–Ω–æ–º—É –≤–æ–ª–µ–π–±–æ–ª—É?",
            "options": ["–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å (–°–®–ê)", "–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ (–ë—Ä–∞–∑–∏–ª–∏—è)", "–ú–∞—Ä—Å–µ–ª—å (–§—Ä–∞–Ω—Ü–∏—è)", "–ú–∞–π–∞–º–∏ (–°–®–ê)"],
            "answer": "–†–∏–æ-–¥–µ-–ñ–∞–Ω–µ–π—Ä–æ (–ë—Ä–∞–∑–∏–ª–∏—è)",
            "explanation": "–ü–µ—Ä–≤—ã–π –ß–ú –ø—Ä–æ–≤–µ–ª–∏ –∏–º–µ–Ω–Ω–æ –≤ –ë—Ä–∞–∑–∏–ª–∏–∏, –æ–¥–Ω–æ–π –∏–∑ —Å–∏–ª—å–Ω–µ–π—à–∏—Ö –≤ –ø–ª—è–∂–Ω–æ–º –≤–æ–ª–µ–π–±–æ–ª–µ."
        },
        {
            "question": "39. –í –∫–∞–∫–æ–º –≥–æ–¥—É —Å–æ—Å—Ç–æ—è–ª—Å—è –ø–µ—Ä–≤—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞ –ø–æ –≤–æ–ª–µ–π–±–æ–ª—É —Å—Ä–µ–¥–∏ –∂–µ–Ω—â–∏–Ω?",
            "options": ["1949", "1952", "1956", "1957"],
            "answer": "1952",
            "explanation": "–í 1952 –≥–æ–¥—É –≤ –ú–æ—Å–∫–≤–µ –ø—Ä–æ—à—ë–ª –ø–µ—Ä–≤—ã–π –ß–ú —Å—Ä–µ–¥–∏ –∂–µ–Ω—â–∏–Ω."
        },
        {
            "question": "40. –ö–æ–≥–¥–∞ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö –≤–æ–ª–µ–π–±–æ–ª–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ–∑–∏—Ü–∏—è ¬´–ª–∏–±–µ—Ä–æ¬ª?",
            "options": ["1994", "1996", "1998", "2000"],
            "answer": "1998",
            "explanation": "–ü–æ–∑–∏—Ü–∏—é –ª–∏–±–µ—Ä–æ –≤–≤–µ–ª–∏ –≤ 1998 –≥–æ–¥—É, —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å –∑–∞—â–∏—Ç—É."
        },
    ]
}

# -------------------------
# –ö–æ–º–∞–Ω–¥—ã /start –∏ /cancel
# -------------------------
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /start ‚Äî –ü–µ—Ä–µ—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    return await show_main_menu(update, context)

async def cancel_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /cancel ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã (–∏ –≤–æ–∑–≤—Ä–∞—Ç –∫ –º–µ–Ω—é).
    """
    context.user_data.clear()
    await update.message.reply_text("–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!")
    return await show_main_menu(update, context)

# -------------------------
# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
# -------------------------
async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –í—ã–≤–æ–¥–∏–º –º–µ–Ω—é —Å —Ç—Ä–µ–º—è –∫–Ω–æ–ø–∫–∞–º–∏:
    1) –ù–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    2) –õ—É—á—à–∏–µ –∏–≥—Ä–æ–∫–∏ (—Ç–æ–ø-10)
    3) –ù–∞—à –º–∞–≥–∞–∑–∏–Ω
    """
    keyboard = [
        ["\U0001F3AF –ù–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É"],   # üéØ
        ["\U0001F3C6 –õ—É—á—à–∏–µ –∏–≥—Ä–æ–∫–∏"],      # üèÜ
        ["\U0001F6D2 –ù–∞—à –º–∞–≥–∞–∑–∏–Ω"]         # üõí
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )
    return MAIN_MENU

async def main_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
    """
    choice = update.message.text.strip()

    if choice == "\U0001F3AF –ù–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É":
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è (ASK_NAME)
        await update.message.reply_text(
            "–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
            reply_markup=ReplyKeyboardRemove()
        )
        return ASK_NAME

    elif choice == "\U0001F3C6 –õ—É—á—à–∏–µ –∏–≥—Ä–æ–∫–∏":
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-10
        rows = get_top_players_db(limit=10)
        if not rows:
            text = "\U0001F3C6 –¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤:\n–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∏–≥—Ä–∞–ª."
        else:
            text = "\U0001F3C6 –¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤:\n"
            for i, (uname, score) in enumerate(rows, start=1):
                text += f"{i}. {uname}: {score}\n"
        await update.message.reply_text(text)
        return await show_main_menu(update, context)

    elif choice == "\U0001F6D2 –ù–∞—à –º–∞–≥–∞–∑–∏–Ω":
        # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª –∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω
        await update.message.reply_text(
            "–ù–∞—à –º–∞–≥–∞–∑–∏–Ω \U0001F6CD –∑–¥–µ—Å—å: https://t.me/<–≤–∞—à_–∫–∞–Ω–∞–ª_–º–∞–≥–∞–∑–∏–Ω–∞>\n\n–ñ–¥—ë–º –≤–∞—Å!",
            reply_markup=ReplyKeyboardRemove()
        )
        # –í–µ—Ä–Ω—ë–º—Å—è –∫ –º–µ–Ω—é
        return await show_main_menu(update, context)

    else:
        # –ù–µ–ø–æ–Ω—è—Ç–Ω—ã–π –≤–≤–æ–¥ ‚Äî –≤–µ—Ä–Ω—ë–º—Å—è –∫ –º–µ–Ω—é
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –∏–∑ –º–µ–Ω—é.")
        return MAIN_MENU

# -------------------------
# –õ–æ–≥–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (ASK_NAME) -> –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (CHOOSE_CATEGORY)
# -------------------------
async def ask_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -> —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
    """
    user_id = str(update.effective_user.id)
    username_input = update.message.text.strip()

    # –û–±–Ω–æ–≤–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–¥–∏–º –∑–∞–ø–∏—Å—å –≤ –ë–î (–¥–æ–±–∞–≤–∏–º 0, –µ—Å–ª–∏ –Ω–µ—Ç)
    update_score_db(user_id, username_input, 0)

    context.user_data["username"] = username_input

    categories = list(quiz_data.keys())  # ["–ü—Ä–∞–≤–∏–ª–∞ –≤–æ–ª–µ–π–±–æ–ª–∞ üèê", "–ò—Å—Ç–æ—Ä–∏—è –≤–æ–ª–µ–π–±–æ–ª–∞ üìñ"]
    keyboard = [[cat] for cat in categories]

    await update.message.reply_text(
        f"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {username_input}!\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:",
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    )
    return CHOOSE_CATEGORY

async def choose_category(update: Update, context: ContextTypes.DEFAULT_TYPE):
    category = update.message.text.strip()
    if category not in quiz_data:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞!")
        return CHOOSE_CATEGORY

    context.user_data["category"] = category
    questions = quiz_data[category][:]
    random.shuffle(questions)
    for q in questions:
        random.shuffle(q["options"])

    context.user_data["questions"] = questions
    context.user_data["current_question_index"] = 0
    context.user_data["score_this_round"] = 0

    await update.message.reply_text(
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {category}\n–ù–∞—á–∏–Ω–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –î–ª—è –≤—ã—Ö–æ–¥–∞ ‚Äî /cancel."
    )
    return await ask_question(update, context)

# -------------------------
# –õ–æ–≥–∏–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ (ASK_QUESTION)
# -------------------------
async def ask_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    index = context.user_data["current_question_index"]
    questions = context.user_data["questions"]

    if index >= len(questions):
        return await end_quiz(update, context)

    question_data = questions[index]
    question_text = question_data["question"]
    options = question_data["options"]

    keyboard = [[opt] for opt in options]
    await update.message.reply_text(
        f"\U0001F4AC –í–æ–ø—Ä–æ—Å {index+1}/{len(questions)}:\n{question_text}",
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    )
    return ASK_QUESTION

async def check_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_answer = update.message.text.strip()
    index = context.user_data["current_question_index"]
    questions = context.user_data["questions"]
    question_data = questions[index]

    correct_answer = question_data["answer"]
    explanation = question_data["explanation"]
    username = context.user_data["username"]

    if user_answer == correct_answer:
        context.user_data["score_this_round"] += 1
        text = (
            "\U00002705 –í–µ—Ä–Ω–æ! +1 –æ—á–∫–æ.\n"
            f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}\n"
            f"–ü–æ—è—Å–Ω–µ–Ω–∏–µ: {explanation}"
        )
    else:
        text = (
            "\U0000274C –ù–µ–≤–µ—Ä–Ω–æ.\n"
            f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}\n"
            f"–ü–æ—è—Å–Ω–µ–Ω–∏–µ: {explanation}"
        )

    await update.message.reply_text(text, reply_markup=ReplyKeyboardRemove())

    context.user_data["current_question_index"] += 1
    return await ask_question(update, context)

async def end_quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    score_this_round = context.user_data["score_this_round"]
    username = context.user_data["username"]

    # –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏ –≤ –ë–î
    update_score_db(user_id, username, score_this_round)

    await update.message.reply_text(
        f"\U0001F389 –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
        f"–¢—ã –Ω–∞–±—Ä–∞–ª {score_this_round} –æ—á–∫(–∞/–æ–≤) –∑–∞ —ç—Ç—É –∏–≥—Ä—É.\n"
        f"–ü–æ—Å–º–æ—Ç—Ä–∏–º —Ç–≤–æ–π –æ–±—â–∏–π —Å—á—ë—Ç ‚Äî –æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω!"
    )

    # –ü—Ä–µ–¥–ª–æ–∂–∏–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é
    keyboard = [["\U000021A9 –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é"]]
    await update.message.reply_text(
        text="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    )

    # –°–±—Ä–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
    context.user_data["questions"] = []
    context.user_data["current_question_index"] = 0
    context.user_data["score_this_round"] = 0

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ MAIN_MENU, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç –∫–Ω–æ–ø–∫—É
    return MAIN_MENU

# -------------------------
# –§—É–Ω–∫—Ü–∏—è main
# -------------------------
def main():
    # –ß–∏—Ç–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    token = os.environ.get("BOT_TOKEN")
    if not token:
        logger.error("–ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏!")
        return

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É (PostgreSQL)
    init_db()

    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PicklePersistence –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
    persistence = PicklePersistence(filepath="bot_state.pkl")
    application = ApplicationBuilder().token(token).persistence(persistence).build()

    # –û–ø–∏—Å—ã–≤–∞–µ–º ConversationHandler
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start_command)],
        states={
            MAIN_MENU: [MessageHandler(filters.TEXT & ~filters.COMMAND, main_menu_handler)],
            ASK_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_name)],
            CHOOSE_CATEGORY: [MessageHandler(filters.TEXT & ~filters.COMMAND, choose_category)],
            ASK_QUESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, check_answer)],
        },
        fallbacks=[CommandHandler("cancel", cancel_command)],
    )

    application.add_handler(conv_handler)

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")
    application.run_polling()

if __name__ == "__main__":
    main()
